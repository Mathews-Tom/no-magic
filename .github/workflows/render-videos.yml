name: Render Algorithm Videos

on:
  pull_request:
    paths:
      - 'videos/scenes/**'
      - 'videos/render.sh'
      - 'assets/video_start_frame.png'
      - 'assets/video_end_frame.png'
  workflow_dispatch:
    inputs:
      scene:
        description: 'Single scene name to render (e.g., microattention), or leave empty for all changed'
        required: false
        default: ''

permissions:
  contents: read

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      scenes: ${{ steps.changed.outputs.scenes }}
      has_scenes: ${{ steps.changed.outputs.has_scenes }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed scene files
        id: changed
        run: |
          if [ -n "${{ github.event.inputs.scene }}" ]; then
            # Manual dispatch: use the specified scene
            echo "scenes=[\"${{ github.event.inputs.scene }}\"]" >> "$GITHUB_OUTPUT"
            echo "has_scenes=true" >> "$GITHUB_OUTPUT"
          else
            # PR trigger: find scene files changed vs base branch
            BASE="${{ github.event.pull_request.base.sha }}"
            HEAD="${{ github.sha }}"
            CHANGED=$(git diff --name-only "$BASE" "$HEAD" -- 'videos/scenes/scene_*.py' \
              | sed 's|videos/scenes/scene_||;s|\.py||' \
              | jq -R -s -c 'split("\n") | map(select(length > 0))')
            echo "scenes=$CHANGED" >> "$GITHUB_OUTPUT"
            if [ "$CHANGED" = "[]" ] || [ -z "$CHANGED" ]; then
              echo "has_scenes=false" >> "$GITHUB_OUTPUT"
            else
              echo "has_scenes=true" >> "$GITHUB_OUTPUT"
            fi
          fi

  render:
    needs: detect-changes
    if: needs.detect-changes.outputs.has_scenes == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libcairo2-dev libpango1.0-dev ffmpeg

      - name: Install Manim
        run: pip install -r videos/requirements.txt

      - name: Render changed scenes (full MP4 only)
        run: |
          SCENES='${{ needs.detect-changes.outputs.scenes }}'
          for scene in $(echo "$SCENES" | jq -r '.[]'); do
            echo "=== Rendering: $scene ==="
            bash videos/render.sh --full-only "$scene"
          done

      - name: Upload MP4 renders as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: algorithm-videos
          path: videos/renders/*.mp4
          retention-days: 30
