name: Render Algorithm Videos

on:
  push:
    paths:
      - 'videos/scenes/**'
      - 'videos/render.sh'
      - 'assets/video_start_frame.png'
      - 'assets/video_end_frame.png'
  workflow_dispatch:
    inputs:
      scene:
        description: 'Single scene name to render (e.g., microattention), or leave empty for all'
        required: false
        default: ''
      quality:
        description: 'Render mode'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - preview-only
          - full-only

permissions:
  contents: write

jobs:
  render:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libcairo2-dev libpango1.0-dev ffmpeg gifsicle

      - name: Install Manim
        run: pip install -r videos/requirements.txt

      - name: Render scenes
        run: |
          ARGS=""
          if [ "${{ github.event.inputs.quality }}" = "preview-only" ]; then
            ARGS="--preview-only"
          elif [ "${{ github.event.inputs.quality }}" = "full-only" ]; then
            ARGS="--full-only"
          fi
          if [ -n "${{ github.event.inputs.scene }}" ]; then
            ARGS="$ARGS ${{ github.event.inputs.scene }}"
          fi
          bash videos/render.sh $ARGS

      - name: Commit updated GIF previews
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add videos/previews/*.gif
          if git diff --cached --quiet; then
            echo "No GIF changes to commit"
          else
            git commit -m "ci(videos): update GIF previews [skip ci]"
            git push
          fi

      - name: Upload MP4 renders as artifacts
        if: ${{ github.event.inputs.quality != 'preview-only' }}
        uses: actions/upload-artifact@v4
        with:
          name: algorithm-videos
          path: videos/renders/*.mp4
          retention-days: 30

  release:
    needs: render
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download rendered videos
        uses: actions/download-artifact@v4
        with:
          name: algorithm-videos
          path: videos/

      - name: Create GitHub Release with videos
        uses: softprops/action-gh-release@v2
        with:
          files: videos/*.mp4
          body: |
            ## Algorithm Visualization Videos

            Short animated explanations of the algorithms in no-magic, generated with [Manim](https://www.manim.community/).

            Download individual MP4s below, or view GIF previews in the [README](https://github.com/Mathews-Tom/no-magic#see-it-in-action).
